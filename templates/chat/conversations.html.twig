{% extends('mainpage/main.html.twig') %}
{% block content %}
    <style>
        .newMessage {
            background: gray;
            width: 60%;
            margin: 15px 15px;
            color: white;
            /*background: #00cc00;*/
            padding: 10px;
            border-radius: 5px;
            min-height: 40px;
            word-wrap: break-word;
            font-size: 18px;
            font-weight: bold;
        }

        .oldMessage {
            width: 60%;
            margin: 15px 15px;
            color: white;
            background: #00b300;
            padding: 10px;
            border-radius: 5px;
            min-height: 40px;
            word-wrap: break-word;
            font-size: 18px;
            font-weight: bold;
            margin-left: 37%;
        }
    </style>
    <div class="container-fluid mt-5">
        <div class="row" style="min-height: 550px; max-height: 550px;">
            <div class="col-3 ml-3"
                 style="border: 1px solid lightgray; height: 100%; padding: 0; background: white; min-height: 550px; max-height: 550px;">
                <div class="mt-2 mb-2" style="text-align:center;">
                    <h3><span style="cursor: default;">Conversations</h3>
                </div>
                <div class="users" style="overflow-y: scroll; overflow-y: scroll;min-height:450px; max-height: 450px;">
                    {% for conversation in conversations %}
                        <div class="row" style="border-top: 1px solid lightgray; height: 100%; padding: 5px;">
                            <div div="col-4" style="padding-top: 10px; padding-bottom: 10px;">
                                <img class="ml-3" style="height: 30px; width: auto; border-radius:50%;"
                                     src="{{ asset('images/user2.png') }}">
                            </div>
                            <div class="col-8 ml-2" style="padding-top: 10px; padding-bottom: 10px;">
                                {% if app.user.id == conversation.user1.Id %}
                                    <a class="selectChat"
                                       href="{{ path('one_chat', {conversation: conversation.Id}) }}">
                                        <h5>{{ conversation.user2.login }}</h5></a>
                                {% elseif app.user.Id != conversation.user1.Id %}
                                    <a class="selectChat"
                                       href="{{ path('one_chat', {conversation: conversation.Id}) }}">
                                        <h5>{{ conversation.user1.login }}</h5></a>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            {% if topic is defined %}
                <div class="col-8 ml-5" style="border: 1px solid lightgray; padding: 0; background: white;">
                    <div style="border-bottom: 1px solid gray;">
                        <div class="mt-2 mb-2" style="text-align:center;">
                            <h3><span style="cursor: default;">Messages</span></h3>
                        </div>
                    </div>
                    <div class="interceptedMessages" style="overflow-y: scroll;min-height:450px; max-height: 450px;">
                        {% for message in messages %}
                            {% if message.Sender == app.user %}
                                <div class="oldMessage">
                                    {{ message.Content }}
                                </div>
                            {% else %}
                                <div class="newMessage">
                                    {{ message.Content }}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <div style="border-top: 1px solid lightgray;">
                        <input style="width: 80%; border: none; padding-left: 15px;" type="text" class="messageInput"
                               name="Content" required>
                        <button onclick="sendMessage()" style="width: 19.6%; border-radius:0px;"
                                class="btn btn-secondary button_send">Send
                        </button>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
    {% if topic is defined %}
        <script>
            window.onload = function () {
                var scrolledDiv = document.querySelector(".interceptedMessages");
                scrolledDiv.scrollTop = scrolledDiv.scrollHeight;
            }

            var messageFromInput = "";

            const url = new URL('http://localhost:8080/hub');
            url.searchParams.append('topic', {{ topic }});
            const eventSource = new EventSource(url)
            eventSource.onmessage = e => {
                $interceptedMessage = e.data;

                if (messageFromInput === $interceptedMessage) {
                    document.querySelector(".interceptedMessages").insertAdjacentHTML('beforeend', "<div class=" + "oldMessage" + ">" + $interceptedMessage + "</div>")
                } else {
                    document.querySelector(".interceptedMessages").insertAdjacentHTML('beforeend', "<div class=" + "newMessage" + ">" + $interceptedMessage + "</div>")
                }

                var scrolledDiv = document.querySelector(".interceptedMessages");
                scrolledDiv.scrollTop = scrolledDiv.scrollHeight;
            }

            function sendMessage() {
                let message = document.querySelector(".messageInput").value;
                messageFromInput = message;

                $.ajax({
                    url: "{{ path('send_message', {topic: topic}) }}",
                    method: "POST",
                    data: {Content: message},
                });
                document.querySelector(".messageInput").value = "";
            }
        </script>
    {% endif %}
{% endblock %}
